# Trajectory Tracking
> This document will introduce the file structure of the trajectory tracking module, the data interaction between various communication nodes, as well as the configuration of startup files and algorithm parameters.

## Overview
The trajectory tracking is a core module in Autoware. It is responsible for tracking the reference trajectory by using the lateral and longitudinal controllers to follow the trajectory points sent by the trajectory planning module.

## File Structure
The trajectory tracking module is located in [autoware.universe/control](https://github.com/autowarefoundation/autoware.universe/tree/main/control) and has the following structure:

|Directory                         | Brief Description  
|----------------------------------|------------------------------------------------------------------------------------------------------------------------  
|autonomous_emergency_braking      | Automatic Emergency Braking (AEB), which prevents collisions between the predicted trajectory (provided by the lateral controller) and obstacles
|control_performance_analysis      | Control performance analysis, which analyzes the tracking performance of the trajectory tracking module and monitors the driving status of the vehicle
|external_cmd_selector             | External command selector, switches vehicle mode (remote control mode/autonomous driving mode) according to input commands and current mode
|joy_controller                    | Joy controller, which converts remote control messages into vehicle control commands required by Autoware (such as steering angle, gear, turn signal, start key, etc.)
|mpc_lateral_controller            | Implementation of the MPC (Model Predictive Control) algorithm for lateral control. It generates lateral control commands (steering angle and steering rate) to follow the path and uses the vehicle model to simulate the trajectory generated by the control commands.
|obstacle_collision_checker        | Obstacle collision checker, which checks for collisions with obstacles using the predicted trajectory generated by the lateral controller and publishes diagnostic errors when a collision is detected.
|operation_mode_transition_manager | Operation mode transition manager, responsible for managing different operation modes of Autoware system. Possible modes are: `Autonomous`, `Local`, `Remote`, and `Stop`.
|pid_longitudinal_controller       | PID longitudinal controller, which uses the trajectory points speed sent by the Planner module as the reference speed, calculates the vehicle acceleration control signal using the PID algorithm, and achieves the specified target speed when passing through the target trajectory.
|pure_pursuit                      | Pure pursuit lateral controller, which implements the pure pursuit algorithm to generate lateral control commands (steering angle and steering rate) to track the path. 
|shift_decider                     | Shift decider, determines the size of the gear based on the control instructions output by controller.
|trajectory_follower_base          | Trajectory tracking controller interface, which provides a unified interface for lateral and longitudinal controllers for trajectory_follower_node.
|trajectory_follower_node          | Trajectory tracking controller node, which is a functional node implemented in the controller class derived from trajectory_follower_base, generating control commands to track the reference trajectory.
|vehicle_cmd_gate                  | Vehicle command throttle, a package that obtains information from emergency processing programs, planning modules, and external controllers and sends messages to the vehicle.


  
## Data Interaction
#### Message Passing
To be completed.

#### Key Topic Subscription List
To be completed.

#### Key Topic Publishing List
To be completed.

#### Detailed Topic Subscription List
|Topic Name | Message Type | Subscribed Node
|----------------------------------------------------------|--------------------------------------------------------|----------------------------------------------
|/autoware/state                                           | autoware_auto_system_msgs/msg/AutowareState            | shift_decider
|/control/command/control_cmd                              | autoware_auto_control_msgs/msg/AckermannControlCommand | operation_mode_transition_manager
|/control/gate_mode_cmd                                    | tier4_control_msgs/msgs/GateMode                       | vehicle_cmd_gate
|/control/shift_decider/gear_cmd                           | autoware_auto_vehicle_msgs/msg/GearCommand             | vehicle_cmd_gate
|/control/trajectory_follower/control_cmd                  | autoware_auto_control_msgs/msg/AckermannControlCommand | shift_decider
|/control/trajectory_follower/lateral/predicted_trajectory | autoware_auto_planning_msgs/msg/Trajectory             | autonomous_emergency_braking<br> lane_departure_checker<br> obstacle_collision_checker<br> 
|/control/vehicle_cmd_gate/operation_mode                  | autoware_adapi_v1_msgs/msg/OperationModeState          | operation_mode_transition_manager
|/external/selected/control_cmd                            | autoware_auto_control_msgs/msg/AckermannControlCommand | vehicle_cmd_gate
|/external/selected/hazard_lights_cmd                      | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate
|/external/selected/gear_cmd                               | autoware_auto_vehicle_msgs/msg/GearCommand             | vehicle_cmd_gate
|/external/selected/heartbeat                              | tier4_external_api_msgs/msg/Heartbeat                  | vehicle_cmd_gate
|/localization/acceleration                                | geometry_msgs/msgs/AccelWithCovarianceStamped          | trajectory_follower_node<br> vehicle_cmd_gate
|/localization/kinematic_state                             | nav_msgs/msgs/Odometry                                 | autonomous_emergency_braking<br> lane_departure_checker<br> obstacle_collision_checker<br> operation_mode_transition_manager<br>  trajectory_follower_node<br> vehicle_cmd_gate  
|/map/vector_map                                           | autoware_auto_mapping_msgs/msg/HADMapBin               | lane_departure_checker<br> obstacle_collision_checker
|/perception/obstacle_segmentation/pointcloud              | sensor_msgs/msg/PointCloud2                            | autonomous_emergency_braking<br> obstacle_collision_checker
|/planning/hazard_lights_cmd                               | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate 
|/planning/mission_planning/route                          | autoware_auto_planning_msgs/msg/LaneletRoute           | lane_departure_checker<br> obstacle_collision_checker
|/planning/scenario_planning/trajectory                    | autoware_auto_planning_msgs/msg/Trajectory             | trajectory_follower_node<br> obstacle_collision_checker<br> operation_mode_transition_manager <br> lane_departure_checker
|/planning/turn_indicators_cmd                             | autoware_auto_vehicle_msgs/msg/TurnIndicatorsCommand   | vehicle_cmd_gate
|/sensing/imu/imu_data                                     | sensor_msgs/msg/Imu                                    | autonomous_emergency_braking
|/system/emergency/control_cmd                             | autoware_auto_control_msgs/msg/AckermannControlCommand | vehicle_cmd_gate
|/system/emergency/gear_cmd                                | autoware_auto_vehicle_msgs/msg/GearCommand             | vehicle_cmd_gate
|/system/emergency/hazard_lights_cmd                       | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate
|/system/fail_safe/mrm_state                               | autoware_adpi_v1_msgs/msgs/MrmState                    | vehicle_cmd_gate 
|/system/operation_mode/state                              | autoware_adpi_v1_msgs/msgs/OperationModeState          | vehicle_cmd_gate<br> trajectory_follower_node
|/vehicle/status/control_mode                              | autoware_auto_vehicle_msgs/msg/ControlMoedReport       | operation_mode_transition_manager
|/vehicle/status/gear_status                               | autoware_auto_vehicle_msgs/msg/GearReport              | vehicle_cmd_gate
|/vehicle/status/steering_status                           | autoware_auto_vehicle_msgs/msgs/SteeringReport         | operation_mode_transition_manager<br> trajectory_follower_node<br> vehicle_cmd_gate<br> 
|/vehicle/status/velocity_status                           | autoware_auto_vehicle_msgs/msgs/VelocityReport         | autonomous_emergency_braking



#### Detailed topic publishing list
| Topic Name | Message Type | Publishing Node
|----------------------------------------------------------|--------------------------------------------------------|----------------------------------------------
|/api/autoware/get/engage                                  | autoware_auto_vehicle_msgs/msg/Engage                  | vehicle_cmd_gate
|/api/autoware/get/emergency                               | autoware_auto_vehicle_msgs/msg/Emergency               | vehicle_cmd_gate
|/control/command/emergency_cmd                            |tire4_vehicle_msgs/msg/VehicleEmergencyStamped          | vehicle_cmd_gate      
|/control/command/control_cmd                              | autoware_auto_control_msgs/msg/AckermannControlCommand | vehicle_cmd_gate
|/control/command/gear_cmd                                 |autoware_auto_vehicle_msgs/msg/GearCommand              | vehicle_cmd_gate
|/control/command/turn_indicators_cmd                      |autoware_auto_vehicle_msgs/msg/TurnIndicatorsCommand    | vehicle_cmd_gate
|/control/command/hazard_lights_cmd                        | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate
|/control/current_gate_mode                                |tire4_control_msgs/msg/GateMode                         | vehicle_cmd_gate
|/control/shift_decider/gear_cmd                           |autoware_auto_vehicle_msgs/msg/GearCommand              | shift_decider
|/control/trajectory_follower/control_cmd                  |autoware_auto_control_msgs/msg/AckermannControlCommand  | trajectory_follower_node
|/control/trajectory_follower/lateral/predicted_trajectory |autoware_auto_planning_msgs/msg/Trajectory              | trajectory_follower_node
|/control/trajectory_follower/lateral/diagnostic           |tier4_debug_msgs/Float32MultiArrayStamped               | trajectory_follower_node
|/control/trajectory_follower/longitudinal/slope_angle     |tier4_debug_msgs/Float32MultiArrayStamped               | trajectory_follower_node
|/control/trajectory_follower/longitudinal/diagnostic      |tier4_debug_msgs/Float32MultiArrayStamped               | trajectory_follower_node
|/control/vehicle_cmd_gate/operation_mode | autoware_adapi_v1_msgs/msgs/OperationModeState                          | vehicle_cmd_gate

## Parameter Configuration
The configuration file location of each node in this module: [autoware_launch/config/control](https://github.com/autowarefoundation/autoware_launch/tree/main/autoware_launch/config/control)
> Note: autoware.universe/control/*/config has the same configuration files as autoware_launch/config/control, but is loaded by default from autoware_launch/config/control


#### Key Configuration Parameters
|Parameter name | Parameter type | Parameter description | Optional value
|----------------------------------|--------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------
|lateral_controller_mode           | string | When [starting launch file](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/launch/components/tier4_control_component.launch.xml)，can specify the lateral controller to be loaded                                                         | mpc（by default），pure_pursuit 
|mpc_weight_steering_input         | double | For [mpc_lateral_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml), it indicates the weight of the steering input. When the weight increases, the steering will be more stable, but the state error between the vehicle and the reference trajectory will increase.           | 0~inf
|mpc_weight_lat_error              | double | For [mpc_lateral_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml), it indicates the weight of lateral error. When the weight increases, the vehicle is closer to the reference trajectory, but it is prone to oscillation                          | 0~inf
|mpc_weight_heading_error          | double | For [mpc_lateral_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml), it indicates the heading error weight, when the weight is larger, the vehicle is more parallel to the trajectory, but it may make the lateral error convergence speed lower         | 0~inf
|mpc_weight_terminal_lat_error     | double | For [mpc_lateral_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml), it indicates the lateral error at the end of the trajectory, when the weight is larger, the lateral error at the end of the vehicle is smaller, but it may affect the stability of the driving process      | 0.0~inf
|mpc_weight_terminal_heading_error | double | For [mpc_lateral_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml), it indicates the heading error at the end of the trajectory, when the weight is larger, the heading error at the end of the vehicle is smaller, but it may affect the stability of the driving process       | 0.0~inf
|mpc_prediction_horizon            | double | For [mpc_lateral_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml), It indicates the prediction time range, the larger the parameter, the longer the prediction time of the vehicle, improving the tracking performance, but the calculation cost will increase               | 0.0~inf [s]
|mpc_prediction_dt                 | double | For [mpc_lateral_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml), It indicates the prediction time interval, the smaller the parameter, the smaller the prediction time interval of the vehicle, improving the tracking performance, but the computational cost will increase           | 0.0~inf [s]
|kp                                | double | For [pid_longitudinal_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/longitudinal/pid.param.yaml),  it indicates the weight of the longitudinal error, the larger the parameter, the smaller the error, but too large will make the motor output too large, you need to set a reasonable range | 0.0~inf
|ki                                | double | For [pid_longitudinal_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/longitudinal/pid.param.yaml), it indicates the weight of the longitudinal integration error, this parameter will make the longitudinal error smaller and smaller, need to set the range reasonably              | 0.0~inf
|kd                                | double | For [pid_longitudinal_controller](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/longitudinal/pid.param.yaml), it indicates the weight of the rate of change of the longitudinal error, and this parameter can reduce the oscillation of the longitudinal error and needs to be set reasonably in the range           | 0.0~inf

#### Detailed configuration parameters
The detailed configuration of each node is shown below.  

|Node Name | Configure File Location |
|--------|---------|
|autonomous_emergency_braking      | <https://autowarefoundation.github.io/autoware.universe/main/control/autonomous_emergency_braking/#parameters>
|control_performance_analysis      | <https://autowarefoundation.github.io/autoware.universe/main/control/control_performance_analysis/#parameters> 
|joy_controller                    | <https://autowarefoundation.github.io/autoware.universe/main/control/joy_controller/#parameters>
|lane_departure_checker            | <https://autowarefoundation.github.io/autoware.universe/main/control/lane_departure_checker/#parameters>
|mpc_lateral_controller            | <https://autowarefoundation.github.io/autoware.universe/main/control/mpc_lateral_controller/#parameter-description>
|obstacle_collision_checker        | <https://autowarefoundation.github.io/autoware.universe/main/control/obstacle_collision_checker/#parameters>
|operation_mode_transition_manager | <https://autowarefoundation.github.io/autoware.universe/main/control/operation_mode_transition_manager/#parameters>
|pid_longitudinal_controller       | <https://autowarefoundation.github.io/autoware.universe/main/control/pid_longitudinal_controller/#parameter-description>
|pure_pursuit                      | None
|shift_decider                     | None
|vehicle_cmd_gate                  | <https://autowarefoundation.github.io/autoware.universe/main/control/vehicle_cmd_gate/#parameters>


## Vehicle kinematic model
According to the given references, the kinematic model of a vehicle with a four-wheel steering actuator<sup>[1]</sup> can be expressed as
![four-wheel-steering-model](images/four-wheel-steering-model.png)

$$
\begin{aligned}
\dot{X} & =V \cos (\psi+\beta) \\
\dot{Y} & =V \sin (\psi+\beta) \\
\dot{\psi} & =\frac{V \cos (\beta)}{\ell_f+\ell_r}\left(\tan \left(\delta_f\right)-\tan \left(\delta_r\right)\right)
\end{aligned}
$$

Where $X$, $Y$, $\psi$ denote the position and heading angle of the vehicle in the global coordinate system, $\beta$ denotes the slip angle of the vehicle , $V$ denotes the velocity of the vehicle, the center of gravity (c.g.) of the vehicle is at point C. The distances of points A  and  B  from  the  c.g.  of  the  vehicle  are $\ell_f$ and $\ell_r$ respectively.

$$
\begin{aligned}
\dot{X} & =V \cos (\psi) \\
\dot{Y} & =V \sin (\psi) \\
\dot{\psi} & =\frac{2 V \tan \left(\delta_f\right)}{\ell_f+\ell_r} 
\end{aligned}
$$

## References
[1]: Rajamani, Rajesh. Vehicle dynamics and control. Springer Science & Business Media, 2011.
